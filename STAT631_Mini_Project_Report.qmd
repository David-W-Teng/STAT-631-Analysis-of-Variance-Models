---
title: "STAT631 Mini Project Report"
author: "David Teng"
date: "`r Sys.Date()`"
output: pdf_document
format: pdf
editor: visual
---

### Data Description

This analysis uses the Right Heart Catheterization (RHC) dataset, which includes 5,735 critically ill adult patients from the SUPPORT study (Study to Understand Prognoses and Preferences for Outcomes and Risks of Treatments), conducted from 1989 to 1994 across five U.S. teaching hospitals. The dataset is publicly available through the Vanderbilt University Department of Biostatistics. For the purpose of this study, the outcome of interest is hospital length of stay, defined as the number of days from admission to discharge. The independent variables examined are sex (male or female), age group (categorized as \<50, 50–65, 65–80, and 80+), and history of cardiovascular disease (yes or no).

### Right Heart Catheterization (RHC) Dataset Overview

Source: Vanderbilt University Department of Biostatistics

Direct Download: <https://hbiostat.org/data/repo/rhc.csv>

Dataset Documentation: <https://search.r-project.org/CRAN/refmans/ATbounds/html/RHC.html>

Study Reference: Connors, A.F., et al. (1996). "The effectiveness of right heart catheterization in the initial care of critically ill patients." JAMA, 276(11), 889–897. DOI: 10.1001/jama.1996.03540110043030

### Research Question

This study examines whether sex, age group, and history of cardiovascular disease (cardiohx) individually or interactively influence hospital length of stay among critically ill patients.

### Load Libraries and Data

```{r}
library(ggplot2)
library(dplyr)
library(multcomp)
library(stats)
library(car)  

df <- read.csv("rhc.csv")
summary(df)
```

### Data Preparation

```{r}
# Create age group categories from continuous age variable
df$age_group <- cut(df$age,
                    breaks = c(0, 50, 65, 80, 100),
                    labels = c("<50", "50-65", "65-80", "80+"),
                    right = FALSE)

# Convert categorical variables to factors
df$sex <- as.factor(df$sex)
df$cardiohx <- as.factor(df$cardiohx)

# Ensure death is a factor and create numeric binary version (if not already)
df$death <- as.factor(df$death)
df$death_num <- ifelse(df$death == "Yes", 1, 0)

# Select variables and drop rows with any missing values in selected columns
df_clean <- na.omit(df[, c("death", "sex", "age", "age_group", "cardiohx",
                           "death_num", "race", "income", "adld3p",
                           "urin1", "dschdte", "sadmdte")])

# Ensure date columns are in Date or DateTime format
df_clean$dschdte <- as.Date(df_clean$dschdte)
df_clean$sadmdte <- as.Date(df_clean$sadmdte)

# Calculate length of stay in days
df_clean$length_of_stay <- as.numeric(df_clean$dschdte - df_clean$sadmdte)

summary(df_clean)
```

### Assumption Checking Before ANOVA

1\. **Independence**

Assumed by study design (random sampling or independent subjects).\
No formal test—assume valid if no clustering/repeated measures.

2\. **Normality of Residuals**

```{r}
# Fit the model:
anova_model <- aov(length_of_stay ~ sex * age_group * cardiohx, data = df_clean)
# Check residual normality:
resid_anova <- residuals(anova_model)
shapiro.test(resid_anova)
qqnorm(resid_anova)
qqline(resid_anova, col = "blue")

```

Since p \< 0.05 **Normality of Residuals** is violated → Consider **transformation (e.g., log, sqrt) or** Logistic Regression

3\. **Equal Variance**

```{r}
# Levene's Test
library(car)
leveneTest(resid_anova ~ interaction(sex, age_group, cardiohx), data = df_clean)

# Fit the ANOVA model
anova_model <- aov(length_of_stay ~ sex * age_group * cardiohx, data = df_clean)

# Extract residuals and fitted values
resid_anova <- residuals(anova_model)
fitted_anova <- fitted(anova_model)

# Plot: Residuals vs. Fitted Values
plot(fitted_anova, resid_anova,
     xlab = "Fitted Values",
     ylab = "Residuals",
     main = "Residuals vs. Fitted Values",
     pch = 20,
     col = "steelblue")
abline(h = 0, col = "red", lwd = 2)


```

**Interpretation**:

Levene p \> 0.05 → Variances are **equal**

Plot: Look for random scatter around 0 (no funnel pattern)

### Option 1: **Log Transformation**

```{r}
# Add a small constant to avoid log(0), if needed
df_clean$log_los <- log(df_clean$length_of_stay + 1)

# Fit the model using log-transformed outcome
anova_model_log <- aov(log_los ~ sex * age_group * cardiohx, data = df_clean)

# Check residuals again
resid_log <- residuals(anova_model_log)
shapiro.test(resid_log)
qqnorm(resid_log)
qqline(resid_log, col = "blue")

```

### Option 2: **Box-Cox Transformation**

```{r}
# Use lm instead of aov for Box-Cox compatibility
library(MASS)
lm_model <- lm(length_of_stay ~  sex * age_group * cardiohx, data = df_clean)

# Apply Box-Cox transformation
boxcox_result <- boxcox(lm_model, lambda = seq(-2, 2, 0.1),
                        main = "Box-Cox Transformation")

# Find optimal lambda
best_lambda <- boxcox_result$x[which.max(boxcox_result$y)]
best_lambda

```

Since `lambda ≈ 0`, then **log transformation** is best.

### 1. Three-Way ANOVA: Effects of Sex, Age Group, and Cardiac History on Hospital Length of Stay (Full Model)

```{r}
# Log-transform length_of_stay (add 1 to avoid log(0))
df_clean$log_los <- log(df_clean$length_of_stay + 1)

# Fit the 3-way ANOVA model using the log-transformed data
anova_full <- aov(log_los ~ sex * age_group * cardiohx, data = df_clean)

# View the summary
summary(anova_full)

```

#### Key Findings:

-   Most **main effects and two-way interactions** were **not statistically significant** (*p* \> 0.05).

-   However, the **interaction between age group and cardiac history** was **statistically significant** (*F* = 3.299, *p* = 0.0201), indicating that the impact of cardiac history on length of stay **varies by age group**.

-   The **three-way interaction** was not significant (*p* = 0.6275), suggesting no combined effect of sex, age, and cardiac history on LOS.

### 2. Two-Way ANOVA for Age Group × Cardiac History (Reduced Model)

Since the **three-way ANOVA** showed that only the **interaction between age group and cardiac history** is significant, it's appropriate to fit a **reduced Two-Way ANOVA model** including just those two variables and their interaction.

```{r}
# Fit reduced two-way ANOVA model
anova_reduced <- aov(log_los ~ age_group * cardiohx, data = df_clean)

# Summary of the model
summary(anova_reduced)

```

### **Key Interpretation:**

-   **No main effect** of age group or cardiac history alone on log-transformed length of stay.

-   The **interaction between age group and cardiac history is significant** (*p* = 0.0388), meaning: The effect of cardiac history on length of stay **differs by age group**, or vice versa.

### **ANOVA model comparison**

```{r}
anova(anova_reduced, anova_full)
```

This test if the reduced model provides a **significantly better fit** than the full odel. Since the p-value is **not significant** and Residual Sum of Squares (RSS) barely changed, then the **reduced model is sufficient**.

### AIC/ BIC Comparison

```{r}
# Compare AIC values
AIC(anova_reduced, anova_full)
# Compare BIC values
BIC(anova_reduced, anova_full)
```

### 

### Interpretation of AIC/ BIC comparisons:

The reduced model (which includes only age group, cardiac history, and their interaction) has a lower AIC than the full model by **11.57 points**. A difference in AIC greater than 10 is considered **strong evidence** in favor of the simpler model. Based on this AIC comparison, the reduced model is **strongly preferred** over the full model. Removing the non-significant terms involving sex improves **model parsimony** without sacrificing model performance.

Similarly, the **Bayesian Information Criterion (BIC)** further supports this conclusion. The reduced model has a BIC of **1281.28**, while the full model's BIC is **1328.47**, yielding a difference of over **47 points**. Since BIC penalizes model complexity more heavily than AIC, this substantial gap provides **very strong evidence** that the reduced model offers a more efficient and generalizable fit.

### Model Comparison Table

| Model             | Residual DF | Residual SS | AIC     | BIC     | ANOVA p-value |
|------------|------------|------------|------------|------------|------------|
| **Full Model**    | 618         | 253.80      | 1252.78 | 1328.47 | 0.8258        |
| **Reduced Model** | 626         | 255.58      | 1241.21 | 1281.28 | —             |

### Model Decision:

The **reduced model** (including only age group, cardiac history, and their interaction) is preferred. It has **lower AIC and BIC values**, and the **ANOVA comparison** shows no significant loss of fit when the non-significant sex-related terms are removed (*p* = 0.8258).

### Tukey HSD Post-Hoc Analysis of Age Groups on Hospital Length of Stay

based on reduced model:

```{r}
# Fit one-way ANOVA on log-transformed outcome by age_group
anova_log <- aov(log_los ~ age_group, data = df_clean)

# Tukey HSD post-hoc test
TukeyHSD(anova_log)


```

### **Conclusion:**

There is **no evidence** that hospital length of stay differs significantly by age group based on Tukey’s multiple comparisons. All group differences were small and not statistically meaningful.

We run **separate ANOVAs within levels** of `cardiohx` or `age_group` and then do Tukey on `age_group` inside each subgroup.

### Tukey HSD Post-Hoc Analysis: Age Group Differences in Length of Stay Among Patients With Cardiac History

based on reduced model:

```{r}
# --- Subset: Patients WITH cardiac history (cardiohx == "1")
with_cardio_1 <- subset(df_clean, cardiohx == "1")
anova_sub_1_log <- aov(log_los ~ age_group, data = with_cardio_1)
TukeyHSD(anova_sub_1_log)

# --- Subset: Patients WITHOUT cardiac history (cardiohx == "0")
with_cardio_0 <- subset(df_clean, cardiohx == "0")
anova_sub_0_log <- aov(log_los ~ age_group, data = with_cardio_0)
TukeyHSD(anova_sub_0_log)


```

### Conclusion:

In both the cardiac history and non-cardiac history subgroups, **Tukey HSD post-hoc comparisons revealed no statistically significant differences** in hospital length of stay across age groups. Overall, **age group alone did not significantly influence hospital stay duration within either cardiac history subgroup**.

### Interaction Plot for Age Group × Cardiac History → Length of Stay

```{r}
library(dplyr)
library(ggplot2)

# Summarize log-transformed mean length of stay by age group and cardiac history
plot_data <- df_clean %>%
  group_by(age_group, cardiohx) %>%
  summarise(mean_log_los = mean(log_los, na.rm = TRUE), .groups = "drop")

# Plot interaction
ggplot(plot_data, aes(x = age_group, y = mean_log_los, color = cardiohx, group = cardiohx)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1) +
  labs(
    title = "Interaction Plot: Age Group × Cardiac History → Log Length of Stay",
    x = "Age Group",
    y = "Mean Log Length of Stay",
    color = "Cardiac History"
  ) +
  theme_minimal()

```

### Interpretation of Interaction Plot:

The plot illustrates a **statistically significant interaction** between **age group** and **cardiac history** (*p* = 0.0388), indicating that the effect of age on hospital length of stay depends on whether the patient has a history of cardiovascular disease.

-   For patients **without cardiac history** (red line), length of stay is relatively stable but peaks in the **65–80** age group.

-   For patients **with cardiac history** (blue line), length of stay **decreases sharply with age**, especially after 50–65.

-   This crossover pattern supports a meaningful interaction: the direction and strength of the age effect **differs by cardiac history group**.

### Boxplot for Age Group × Cardiac History

```{r}
library(ggplot2)

ggplot(df_clean, aes(x = age_group, y = log_los, fill = age_group)) +
  geom_boxplot(outlier.shape = 21, outlier.size = 1.5, alpha = 0.8) +
  facet_wrap(~ cardiohx, labeller = label_both) +
  labs(
    title = "Log-Transformed Length of Stay by Age Group and Cardiac History",
    x = "Age Group",
    y = "Log Length of Stay"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

**Log Length of Stay by Age Group and Cardiac History:**

This plot reveals that patients with a history of cardiovascular disease (right panel) generally show a **steeper decline** in length of stay with increasing age, particularly in the 65–80 group. In contrast, patients **without cardiac history** (left panel) exhibit **more stable median lengths of stay** across age groups, with slightly elevated values in the \<50 and 65–80 categories. The variability (IQR and outliers) appears wider in some younger groups, especially for those without cardiac history.

### Final Conclusion

This study utilized the Right Heart Catheterization (RHC) dataset from the SUPPORT study to investigate how age group and cardiac history influence hospital length of stay among critically ill patients. After verifying ANOVA assumptions and applying a log transformation to correct for skewness, a three-way ANOVA model was initially fitted including sex, age group, and cardiac history. However, model comparison via ANOVA and information criteria (AIC and BIC) revealed that a reduced two-way ANOVA model — including only age group, cardiac history, and their interaction — offered equivalent or better model fit with greater parsimony.

The reduced model identified a statistically significant interaction between age group and cardiac history (p = 0.0388), indicating that the effect of age on length of stay depends on cardiac history status. Specifically, length of stay decreased with age among patients with cardiac history, while those without cardiac history showed relatively stable or increasing patterns in older age groups. These trends were confirmed through interaction plots and supported by Tukey HSD post-hoc comparisons, although no pairwise differences were statistically significant.

Visualizations, including boxplots and interaction plots, further illustrated this interaction effect. While sex did not contribute significantly to explaining variation in length of stay, the age group × cardiac history interaction emerged as a meaningful and interpretable driver of variation in hospital resource use.

In summary, this study concludes that the interaction between age group and cardiac history significantly affects hospital length of stay. A reduced two-way ANOVA model provides a more efficient and statistically supported explanation than a full model including sex. These findings highlight the importance of considering both age and comorbid conditions when analyzing healthcare utilization in critical care populations.
